<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (тот же контент в head, что и раньше) ... -->
</head>
<body>
    <div class="container">
        <!-- ... (та же HTML-структура, что и раньше) ... -->
    </div>

    <script>
        // Константы
        const TRONSCAN_API_KEY = "773e8448-b3a3-4cfe-b436-b8968875d027"; // Лучше хранить на сервере
        const paymentWalletAddress = "TNXpbaEghJV14poiqWxyjNWn6wotiKPb1B"; // Ваш TRON-адрес

        // Защита от XSS (Cross-Site Scripting)
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#039;');
        }

        // Проверка валидности TRON-адреса
        function isValidTronAddress(address) {
            return /^T[A-Za-z1-9]{33}$/.test(address);
        }

        // Ограничение частоты запросов (Rate Limiting)
        let lastRequestTime = 0;
        const REQUEST_DELAY = 5000; // 5 секунд между запросами

        async function makeSecureRequest(url, options) {
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_DELAY) {
                throw new Error("Слишком много запросов. Пожалуйста, подождите.");
            }
            lastRequestTime = now;

            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`Ошибка сети: ${response.status}`);
            }
            return response.json();
        }

        // Проверка мультиподписи
        async function checkMultisignatures() {
            const walletAddress = escapeHTML(document.getElementById('walletAddress1').value.trim());
            const resultDiv = document.getElementById('multisigResult');

            if (!isValidTronAddress(walletAddress)) {
                resultDiv.textContent = "Неверный TRON-адрес.";
                return;
            }

            resultDiv.textContent = "Запрос данных мультиподписи...";
            try {
                const data = await makeSecureRequest(`https://api.tronscan.org/api/account?address=${walletAddress}`, {
                    headers: { "TRON-PRO-API-KEY": TRONSCAN_API_KEY }
                });

                if (data.accountMultiSign && Object.keys(data.accountMultiSign).length > 0) {
                    resultDiv.textContent = `Найдена конфигурация мультиподписи: ${escapeHTML(JSON.stringify(data.accountMultiSign))}`;
                } else {
                    resultDiv.textContent = "Конфигурация мультиподписи не найдена.";
                }
            } catch (error) {
                resultDiv.textContent = `Ошибка: ${escapeHTML(error.message)}`;
                console.error(error);
            }
        }

        // Проверка платежа
        async function checkPayment(walletAddress) {
            const paymentStatusDiv = document.getElementById('paymentStatus');
            const scanButton = document.getElementById('scanButton');

            if (!isValidTronAddress(walletAddress)) {
                paymentStatusDiv.textContent = "Неверный TRON-адрес.";
                return;
            }

            paymentStatusDiv.textContent = "Проверка статуса платежа...";
            try {
                const data = await makeSecureRequest(
                    `https://api.tronscan.org/api/transaction?sort=-timestamp&limit=1&from=${walletAddress}&to=${paymentWalletAddress}`,
                    { headers: { "TRON-PRO-API-KEY": TRONSCAN_API_KEY } }
                );

                if (data.data && data.data.length > 0) {
                    const transaction = data.data[0];
                    if (transaction.ownerAddress === walletAddress &&
                        transaction.toAddress === paymentWalletAddress &&
                        transaction.amount >= 1000000) {
                        paymentStatusDiv.textContent = "Платеж подтвержден!";
                        scanButton.disabled = false;
                    } else {
                        paymentStatusDiv.textContent = "Действительный платеж не найден.";
                    }
                } else {
                    paymentStatusDiv.textContent = "Транзакции не найдены.";
                }
            } catch (error) {
                paymentStatusDiv.textContent = `Ошибка: ${escapeHTML(error.message)}`;
                console.error(error);
            }
        }

        // ... (остальная часть JavaScript остается без изменений) ...
    </script>
</body>
</html>
